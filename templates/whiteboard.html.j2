<!DOCTYPE html>
<html>

<!-- Head imports socketio, bootstrap, stylesheets, source code and initialises title and icon -->
<head>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"
    integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
    crossorigin="anonymous"></script>

  <title>Whiteboard</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.png') }}">
  <script type="module">
    import { init } from "{{ url_for('static', filename='whiteboard.js') }}";
    init({{ read_only }});
  </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body style = "height: 100dvh;">
  <!-- Nav bar contains all elements to be stored on the top of the page, including logo and share/rename/delete buttons -->
  <nav class = "whiteboard-navbar">
    <div class = "collab-options-container">
      {% if read_only == 'true' %}
      (Readonly)
      {% else %}
      <button class="btn btn-primary rename-button" id="open-rename-modal-btn">
        Rename File
        <i class="bi bi-card-text"></i>
      </button>

      <form action="/api/delete_file" method="post">
        <input type="hidden" name="fileid" value="{{ fileid }}">
        <button class = "btn btn-primary delete-button" type="submit">Delete</button>
      </form>

      <button class="btn btn-primary share-button" id="open-share-modal-btn">
        Share
        <i class="bi bi-people-fill"></i>
      </button>
      {% endif %}
    </div>
  </nav>

  <svg id="drawing-area" style="stroke: black">
  </svg>

  <!-- Toolbar which contains the tools you use to modify the drawing area -->
  {% if read_only != 'true' %}
  <div class="toolbar">
    <button class="icons iconbutton1 iconbutton btn icon-primary" id="select-selector">
      <i class="bi bi-hand-index-thumb"></i>
    </button>
    <button class="icons iconbutton2 iconbutton btn icon-primary" id="select-pen">
      <i class="bi bi-pencil-fill"></i>
    </button>
    <button class="icons iconbutton3 iconbutton btn icon-primary" id="select-eraser">
      <i class="bi bi-eraser"></i>
    </button>
    <button class="icons iconbutton4 iconbutton btn icon-primary" id="select-shape">
      <i class="bi bi-pentagon"></i>
    </button>
    <button class="icons iconbutton5 iconbutton btn icon-primary" id="group">
      <i class="bi bi-collection"></i>
    </button>
    <br>
    <input id = "specify-sides" type="number" min = "3" placeholder = "Number of sides"><br><br>
  </div>
  {% endif %}

  <!-- Bootstrap modals for sharing, viewing participants, and renaming files -->
  <div class="modal" tabindex="-1" role="dialog" id="share-modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Share</h3>
        </div>
        <div class="modal-body">
          <h4>Share with users by username</h4>
          <form action="/api/share_file" method="post">
            <input type="hidden" name="fileid" value="{{ fileid }}" id="file-id-input">
            <div class="form-group">
              <div class="input-group" style="margin: 20px 0;">
                <input type="text" class="form-control" name="shared_username" placeholder="Username">
                <select name="permission" class="form-select">
                  <option>Read</option>
                  <option>Write</option>
                </select>
              </div>
            </div>
            <div class="form-group" style="width: 100%; text-align: center; margin-bottom: 10px;">
              <button type="submit" class="btn btn-primary">
                Share
              </button>
            </div>
          </form>
          <h5 style="text-align: center;">Or</h5>

          <h4>Get a share link</h4>

          <div class="input-group" style="margin: 20px 0;">
            <select name="permission" class="form-select" id="share-link-permission">
              <option value="Read">Read</option>
              <option value="Write">Write</option>
            </select>
            <button id="share-link-button" class="btn btn-primary">
              Generate
            </button>
          </div>

          <div class="input-group">
            <input type="text" class="form-control" id="share-link-readonly-input" readonly>
            <button class="btn btn-primary" id="copy-share-link-button"><i class="bi bi-copy"></i></button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="rename-modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Rename File</h3>
        </div>
        <div class="modal-body">
          <form action="/api/rename_file" method="post">
            <input type="hidden" name="fileid" value="{{ fileid }}">
            <input name="filename" placeholder="New name" style = "width: 80%;">
            <button type="submit" class="btn btn-primary" style = "float: right;">
              Rename
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Importing and using jquery and bootstrap bundle to show the modals after their corresponding button has been clicked, and implementing functionality to share link modal -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.getElementById('open-rename-modal-btn').addEventListener('click', () => {
      const renameModal = new bootstrap.Modal(document.getElementById('rename-modal'));
      renameModal.show();
    });

    document.getElementById('open-share-modal-btn')?.addEventListener('click', () => {
      const shareModal = new bootstrap.Modal(document.getElementById('share-modal'));
      shareModal.show();
    });

    document.getElementById('share-link-button').addEventListener('click', () => {

      const url = `${window.location.origin}/api/share_link`;
  
      const requestData = new FormData();
      requestData.append('fileid', document.getElementById('file-id-input').value);
      requestData.append('permission', document.getElementById('share-link-permission').value);
  
      const getLinkRequest = fetch(url, {
        method: 'POST',
        body: requestData,
      })
      .then(response => {
  
        response.json().then(jsonData => {document.getElementById('share-link-readonly-input').value = jsonData.shareLink;});
      })
    });
  
    document.getElementById('copy-share-link-button').addEventListener('click', () => {
  
      const copyText = document.getElementById('share-link-readonly-input').value;
  
      navigator.clipboard.writeText(copyText).then(() => {
        console.log("Copied: " + copyText);
      })
      .catch(error => {
        console.error("Failed to copy to clipboard", error);
      });
    });
  </script>

</body>

</html>