<!DOCTYPE html>
<html>

<!-- Head imports flask socketio, source code, the CSS stylesheet, bootstrap and initialises icon and title-->
<head>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"
    integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
    crossorigin="anonymous"></script>

  <script type="module">
    import { init } from "{{ url_for('static', filename='text.js') }}";
    init({{ read_only }});
  </script>


  <title>Text Editor</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.png') }}">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body style = "margin: 0; height: 100em; background: #f9fbfd;">
  <!-- Nav contains everything in the top bar including logo, file name, buttons to edit text, share buttons and delete/rename buttons -->
  <nav class="text-editor-navbar">
    <div class="icon-button-container">
      <a href="/" style="width: 3em; height: 3em;">
        <svg viewBox="0 0 100 100">
          <defs>
            <linearGradient id="paperGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#6a11cb;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#2575fc;stop-opacity:1" />
            </linearGradient>
          </defs>
          <rect x="15" y="5" width="70" height="90" rx="10" ry="10" fill="url(#paperGradient)" />
          <rect x="25" y="20" width="50" height="5" fill="white" opacity="0.7" />
          <rect x="25" y="35" width="50" height="5" fill="white" opacity="0.7" />
          <rect x="25" y="50" width="50" height="5" fill="white" opacity="0.7" />
          <rect x="25" y="65" width="35" height="5" fill="white" opacity="0.7" />
        </svg>
      </a>
    </div>

    <div class="filename-options-container">
      <div class="filename-container">
        <h2 class="main-font" style="margin-bottom: 2em; margin-left: 0.5em;">
          {{ filename }}
        </h2>
      </div>

      <div class="options-container">
        {% if read_only == 'true' %}
        (Readonly)
        {% else %}
        <select class="main-font form-select font-select" id="font-family">
          <option>Arial</option>
          <option>Times New Roman</option>
          <option>Courier New</option>
          <option>Tahoma</option>  
        </select>
        <input id="font-size" type="number" class="form-control font-size-input" value="11">
        <button id="confirm-font-size" class="btn">âœ”</button>

        <span>|</span>

        <button id="bold" class="btn option-btn"><strong>B</strong></button>
        <button id="italic" class="btn option-btn"><i>I</i></button>
        <button id="underline" class="btn option-btn"><u>U</u></button>

        <span>|</span>

        <button id="align-left" class="btn option-btn" style="font-size: 1.25em;">
          <i class="bi bi-text-left"></i>
        </button>
        <button id="align-center" class="btn option-btn" style="font-size: 1.25em;">
          <i class="bi bi-text-center"></i>
        </button>
        <button id="align-right" class="btn option-btn" style="font-size: 1.25em;">
          <i class="bi bi-text-right"></i>
        </button>
        {% endif %} 
      </div>
    </div>

    <div class="collab-options-container">
      {% if read_only == 'false' %}
      <button class="btn btn-primary rename-button" id="open-rename-modal-btn">
        Rename File
        <i class="bi bi-card-text"></i>
      </button>

      <form action="/api/delete_file" method="post">
        <input type="hidden" name="fileid" value="{{ fileid }}">
        <button class = "btn btn-primary delete-button" type="submit">Delete</button>
      </form>

      <button class="btn btn-primary share-button" id="open-share-modal-btn">
        Share
        <i class="bi bi-people-fill"></i>
      </button>

      <button class="btn btn-primary participants-button" id="open-collaborators-btn">
        <i class="fas fa-handshake"></i>
      </button>
      {% endif %}
    </div>
  </nav> 

  <p id="shared-textbox" {% if read_only !='true' %} tabindex="-1" {% endif %} class="main-font shared-textbox-loading">
  </p>

    <!-- Creation of bootstrap modals for sharing, viewing participants and renaming files -->
    <div class="modal" tabindex="-1" role="dialog" id="share-modal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Share</h3>
          </div>
          <div class="modal-body">
            <h4>Share with users by username</h4>
            <form action="/api/share_file" method="post">
              <input type="hidden" name="fileid" value="{{ fileid }}" id="file-id-input">
              <div class="form-group">
                <div class="input-group" style="margin: 20px 0;">
                  <input type="text" class="form-control" name="shared_username" placeholder="Username">
                  <select name="permission" class="form-select">
                    <option>Read</option>
                    <option>Write</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="width: 100%; text-align: center; margin-bottom: 10px;">
                <button type="submit" class="btn btn-primary">
                  Share
                </button>
              </div>
            </form>
            <h5 style="text-align: center;">Or</h5>

            <h4>Get a share link</h4>

            <div class="input-group" style="margin: 20px 0;">
              <select name="permission" class="form-select" id="share-link-permission">
                <option value="Read">Read</option>
                <option value="Write">Write</option>
              </select>
              <button id="share-link-button" class="btn btn-primary">
                Generate
              </button>
            </div>

            <div class="input-group">
              <input type="text" class="form-control" id="share-link-readonly-input" readonly>
              <button class="btn btn-primary" id="copy-share-link-button"><i class="bi bi-copy"></i></button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog" id="collab-modal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Collaborators</h3>
          </div>
          <div class="modal-body">
            <div id="collaborators-list"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog" id="rename-modal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Rename File</h3>
          </div>
          <div class="modal-body">
            <form action="/api/rename_file" method="post">
              <input type="hidden" name="fileid" value="{{ fileid }}">
              <input name="filename" placeholder="New name" style = "width: 80%;">
              <button type="submit" class="btn btn-primary" style = "float: right;">
                Rename
              </button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  <!-- Importing and using jquery and bootstrap bundle to show the modals after their corresponding button has been clicked, and implementing functionality to share link modal -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.getElementById('open-rename-modal-btn').addEventListener('click', () => {
      const renameModal = new bootstrap.Modal(document.getElementById('rename-modal'));
      renameModal.show();
    });

    document.getElementById('open-share-modal-btn')?.addEventListener('click', () => {
      const shareModal = new bootstrap.Modal(document.getElementById('share-modal'));
      shareModal.show();
    });

    document.getElementById('open-collaborators-btn')?.addEventListener('click', () => {
      document.getElementById('collaborators-list').innerHTML = editor.getUsersHTML();
      const collabModal = new bootstrap.Modal(document.getElementById('collab-modal'));
      collabModal.show();
    });

    document.getElementById('share-link-button').addEventListener('click', () => {

      const url = `${window.location.origin}/api/share_link`;
  
      const requestData = new FormData();
      requestData.append('fileid', document.getElementById('file-id-input').value);
      requestData.append('permission', document.getElementById('share-link-permission').value);
  
      const getLinkRequest = fetch(url, {
        method: 'POST',
        body: requestData,
      })
      .then(response => {
  
        response.json().then(jsonData => {document.getElementById('share-link-readonly-input').value = jsonData.shareLink;});
      })
    });
  
    document.getElementById('copy-share-link-button').addEventListener('click', () => {
  
      const copyText = document.getElementById('share-link-readonly-input').value;
  
      navigator.clipboard.writeText(copyText).then(() => {
        console.log("Copied: " + copyText);
      })
      .catch(error => {
        console.error("Failed to copy to clipboard", error);
      });
    });
  </script>
</body>

</html>